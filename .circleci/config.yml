version: 2.1

jobs:
  test:
    docker:
      - image: cimg/python:3.9  # Usando Python 3.9
    steps:
      - checkout
      
      # Crear y activar entorno virtual
      - run:
          name: Crear entorno virtual
          command: |
            python -m venv venv
            . venv/bin/activate

      # Instalar dependencias desde requirements.txt
      - run:
          name: Instalar dependencias
          command: |
            . venv/bin/activate
            pip install -r requirements.txt

      # Ejecutar flake8 para linting
      - run:
          name: Ejecutar Linter
          command: |
            . venv/bin/activate
            flake8 .

      # Ejecutar pruebas con cobertura
      - run:
          name: Ejecutar pruebas
          command: |
            . venv/bin/activate
            pytest --cov-report xml:coverage.xml --cov=.

      # Guardar resultados de pruebas
      - store_test_results:
          path: test-results.xml

      # Guardar cobertura de pruebas
      - store_artifacts:
          path: coverage.xml
          
      # Escaneo de SonarCloud
      - run:
          name: Escanear con SonarCloud
          command: |
            . venv/bin/activate
            sonar-scanner

workflows:
  version: 2
  test-deploy:
    jobs:
      - test
